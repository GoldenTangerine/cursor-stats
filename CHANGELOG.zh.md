<!-- @author SM -->
# 更新日志

本扩展「cursor-stats」的所有重要变更将记录在此文件中。

## [1.2.0] - 2025-01-28

### 新增
- 💳 **Token显示模式**：新增Token使用费用显示模式，替代传统的请求次数显示
  - 可在"经典模式"（请求次数）和"Token模式"（美元费用）之间切换
  - Token模式状态栏格式：`$X.XX/$Y.YY 剩余ZZ%`
  - 工具提示中显示详细的Token分解信息，包含各模型的使用情况和费用
- ⚙️ **新增配置设置**：
  - `cursorStats.displayMode`：选择"classic"或"token"显示模式
  - `cursorStats.tokenMaxAmount`：设置Token使用最大金额（1-1000美元），用于百分比计算
- 🔄 **快速模式切换**：新增 `cursor-stats.switchDisplayMode` 命令，可即时切换显示模式
  - 通过命令面板（Ctrl+Shift+P）访问
  - 显示当前模式并为每个选项提供说明

### 增强
- 🌐 **Token API集成**：
  - 调用 `https://cursor.com/api/dashboard/get-aggregated-usage-events` 获取实时Token使用数据
  - 支持基于团队的Token使用跟踪，具有正确的日期范围筛选
  - 自动从美分转换为美元，格式化精确显示
- 🎨 **状态栏改进**：
  - Token模式使用基于使用百分比的相同颜色编码系统
  - 当Token API失败时智能回退到经典模式
  - 增强工具提示，提供包含输入/输出/缓存Token在内的全面Token统计

### 国际化
- 为所有新的Token相关功能添加中英文翻译
- 新增翻译键：`tokenUsageStats`、`totalTokens`、`inputTokens`、`outputTokens`、`cacheRead`、`cacheWrite`

### 技术改进
- 增强Token使用端点的API错误处理，提供详细日志记录
- 改进TypeScript接口，新增 `TokenUsageResponse` 和 `TokenUsageAggregation` 类型
- 优化团队成员检测，确保准确的Token使用报告

## [1.1.8] - 2025-01-27

### 新增
- ⏱️ **剩余天数功能**：在状态栏显示距离周期结束的剩余天数
  - 状态栏格式：`已用/总数 剩余XX% 📅X天`
  - 工具提示中显示详细的剩余天数信息
  - 根据剩余天数显示不同图标：📅正常、🟡警告（≤7天）、🔴紧急（≤3天）、⏰过期
  - 支持跨年日期计算和多语言月份解析
- ⚙️ **配置开关**：新增 `cursorStats.showRemainingDays` 配置项
  - 默认启用，用户可在设置中自由开启/关闭
  - 影响状态栏和工具提示中的剩余天数显示

### 变更
- 完善国际化支持，为剩余天数功能添加中英文文本

### 技术改进
- 新增 `src/utils/remainingDays.ts` 工具模块，提供完整的剩余天数计算功能
- 优化状态栏和工具提示的条件显示逻辑
- 增强错误处理和边界保护

## [1.1.7] - 2025-08-11

### 新增
- 状态栏新增"剩余百分比"展示：在"已用/总数"后显示"剩余XX%"，智能保留小数位数（最多3位，能除尽的显示整数）。
- 新增「智能使用监控」功能：每 N 次查询检测短时间内的高强度 AI 使用，提醒用户可能选错模型。
  - 可通过设置启用/禁用：`cursorStats.smartUsageMonitorEnabled`（默认启用）
  - 可配置查询间隔次数：`cursorStats.smartUsageMonitorInterval`（默认每 5 次查询检查一次）
  - 可配置使用变化百分比阈值：`cursorStats.smartUsageMonitorThreshold`（默认 10%）
  - 当在短时间内（5 分钟）使用量增长超过阈值时会弹出提醒，并进行频率限制（至少 10 分钟间隔）

### 变更
- 本地化：为新提醒增加多语言键（英/中/日/韩/俄/德/哈）。

### 修复
- 无（本版本以功能与 UI 增强为主）。

## [1.1.5] - 2025-07-03

### 新增
- 🔄 混合数据收集：智能组合团队支出与个人使用 API，提供更全面的统计数据。
- 📊 模型明细增强：在工具提示中展示各 AI 模型的详细使用情况并进行清晰标注。
  - GPT-4（Premium/Fast）：快速高级请求
  - GPT-4-32k（Usage-Based）：基于使用量的支出限额
  - GPT-3.5-turbo：历史型号
- 🔍 团队与个人对比：对于团队成员，清晰区分团队使用与个人使用。
- 🎯 API 逻辑改进：更准确理解 GPT-4-32k 数据中的基于使用量支出限额。

### 变更
- 🔧 API 端点迁移：使用 `get-team-spend` 替代已废弃的 `get-team-usage` 端点。
- 📈 数据来源优先级：团队成员优先使用团队相关的使用数据，同时保留个人上下文。
- 💡 使用量限额检测：通过 GPT-4-32k 的 `maxRequestUsage` 更准确地表示基于使用量的支出限额。
- 🏷️ 模型标注：为模型名称增加更具描述性的标签，提升可读性。
- 🔄 回退机制：当团队 API 失败时自动回退到个人使用 API。

### 修复
- 🐛 请求上限缺失：通过结合个人使用 API，修复团队支出数据中缺少 `maxRequestUsage` 的问题。
- 🎯 数据准确性：团队成员的统计通过团队特定数据得到提升。
- 📊 状态栏展示：改进仪表盘数据与扩展显示的对齐一致性。
- 🔧 错误处理：增强 API 端点迁移期间的错误处理能力。
- 🚨 严重问题：团队成员的基于使用量定价状态检测不一致
  - 后端正确检测团队基于使用量定价为启用
  - UI 工具提示因缺少团队上下文错误显示为“禁用”
  - 通过确保工具提示使用携带 teamId 的团队感知 API 调用予以修复

## [1.1.4] - 2025-06-06

### 新增
- 🌍 国际化（i18n）支持：扩展界面现已支持多语言
  - English（默认）
  - 中文（Chinese）
  - 한국어（Korean）
- 🔧 语言选择：新增命令「Cursor Stats: Select Language」用于快速切换语言。
- ⚙️ 变更日志弹窗控制：新增设置 `cursorStats.showChangelogOnUpdate`，可在扩展升级到新版本时禁用自动弹出变更日志与更新通知（为减少打扰，默认关闭）。

### 变更
- 🌐 所有 UI 元素、通知与消息均可翻译。
- 📈 状态栏与工具提示会随所选语言自动适配。
- 💰 货币名称会根据所选语言本地化显示。
- 🔄 切换语言后界面自动更新。

### 修复
- 🐛 修复团队使用提取中未定义请求的处理。
- 🎯 改进启用计费月份的使用量定价周期计算。
- 🔧 加强本地化边界情况的错误处理。

### 即将推出

#### 计划
- 会话维度的请求跟踪
- 历史使用可视化图表
- 项目级请求使用监控
- 专属活动栏统计视图
- 智能 API 错误处理与指数退避
  - 服务故障期间的自动重试降频
  - 智能刷新频率调节
  - 友好的错误通知
- 自定义能力：
  - 可配置的配额展示选项
  - 显示/隐藏指定模型统计
  - 可定制状态栏信息

## [1.1.3] - 2024-07-27

### 回退
- ⏪ 回退 `v1.1.2` 中的 SQLite 库变更（从 `node-sqlite3-wasm` 回退为 `sql.js`），以修复部分用户的令牌获取错误（尤其是 macOS）。

### 修复
- 🐛 修复 `v1.1.2` 更新后，因新 SQLite 库导致部分用户无法获取访问令牌的问题。

## [1.1.2] - 2025-05-23

### 新增
- ✨ 支出提醒增强：当达到配置阈值的整数倍时也会触发，更细粒度的预警。
- 📊 新增「每日剩余」功能：在工具提示中显示每天预计可用的快速请求数。
  - 新增设置：`cursorStats.showDailyRemaining` 与 `cursorStats.excludeWeekends`
- 🚀 更新时显示变更日志：扩展升级到新版本时，会在 Webview 面板中自动展示变更日志。

### 变更
- 🔧 SQL 库切换：从 `sql.js` 切换为 `node-sqlite3-wasm` 以处理超大数据库文件（>2GB），并通过更健壮的 WASM 方案提升跨平台兼容性。
- 💅 使用量定价详情的工具提示样式优化（对齐与填充更佳）。
- 🛠 未知 AI 模型检测与通知逻辑更精细。
- ⚙️ 修改 `spendingAlertThreshold` 设置后，支出提醒将被重置并重新计算。

### 修复
- 🐛 工具提示中旬支付金额可能不随所选货币更新的问题。
- 🐞 在启用“仅工作日”时，进度条计算的细微不准确问题。

## [1.1.1] - 2025-05-01

### 新增
- 🎨 新增 `cursorStats.statusBarColorThresholds` 设置，用于按使用百分比阈值自定义状态栏文本颜色。

### 变更
- ✨ 使用量定价计算更精准，特别是从总成本与使用百分比计算中排除中旬支付抵扣。
- 📊 工具提示中过滤掉中旬支付条目，并澄清未支付金额计算方式。
- 🔎 加强在使用详情中识别潜在未知模型的能力。
- 🧹 移除少量冗余日志。

## [1.1.0] - 2025-04-22

### 新增
- 🌍 多货币支持
- 📊 使用与周期的进度条可视化
- 📝 诊断报告生成，用于问题排查
- 🎨 更佳的工具提示格式与清晰度
- ⚙️ 自定义数据库路径配置项
- 🔄 模型检测与通知能力提升
- 📈 更好的使用统计呈现
- 💡 可配置阈值的智能进度条

### 变更
- 重构货币处理为实时汇率转换
- 工具提示居中对齐等显示优化
- 改进错误处理与通知
- 更新对新 AI 模型的统计与展示
- 强化状态栏信息呈现
- 配置项组织更清晰
- 货币转换性能优化

### 修复
- 货币显示格式问题
- 进度条阈值计算
- 模型识别准确性
- 使用百分比计算
- 状态栏更新时间点
- 配置变更处理

## [1.0.9] - 2025-02-15

### 新增
- 团队使用支持，包含按用户维度的统计
- 更强的冷却（请求节流）机制
- 更好的窗口焦点管理以提升性能
- 状态更新的智能时间间隔管理
- 全面的错误处理与详细日志

### 变更
- 重构扩展激活与更新逻辑
- 增强团队使用 API，加入 teamId 支持
- 改进通知系统的时序控制
- 更新状态栏刷新机制
- 窗口焦点切换时的性能优化

### 修复
- 冷却周期中的窗口焦点处理
- 状态栏更新时间问题
- 团队使用数据同步
- API 请求节流与冷却逻辑
- 内存使用优化

## [1.0.8] - 2025-02-08

### 新增
- 支出提醒通知，支持可配置的美元阈值
- 远程开发场景下的 UI 扩展宿主兼容
- 新增 `spendingAlertThreshold` 配置项
- 多阈值预警系统（默认 6 个百分比阈值）

### 变更
- 配置结构改为数组式
- 默认刷新间隔从 30 秒提升至 60 秒
- 最小刷新间隔从 5 秒提升至 10 秒
- 为所有配置项补充了 scope 字段
- 更新通知排序逻辑以支持更多阈值

### 移除
- 移除仓库中的历史 VSIX 文件

## [1.0.7] - 2025-02-07

### 新增
- 集成 GitHub 发布说明查看器（Markdown 渲染）
- 细化的发布检查能力，包含详细发布信息
- 支持发布资产与源码下载链接
- 集成 marked 库进行 Markdown 渲染
- 改进 WSL 数据库路径处理

### 变更
- 更新状态栏配色方案，视觉一致性更强
- 将 Windows 用户名工具迁移至数据库服务
- 优化使用成本的显示格式
- 发布信息结构加入更多元数据
- 更新依赖到最新版本

### 移除
- 移除冗余的 Windows 用户名工具模块

## [1.0.6] - 2025-02-06

### 新增
- 感知窗口焦点的刷新间隔
- 中旬支付追踪与提醒
- Stripe 集成以处理未支付账单
- 新增「显示总请求数」配置项
- 更多日志分类用于调试
- 未支付账单告警并可跳转到账单门户

### 变更
- 改进通知排序（高阈值优先）
- 重构基于使用量的计费数据结构
- 优化状态栏工具提示排版
- 计费周期计算：排除中旬支付
- 总请求数的状态栏文本展示调整

### 修复
- 当使用量低于阈值时清理通知
- 窗口焦点变化期间的更新行为
- Stripe 会话 URL 获取的错误处理
- 总请求数显示的配置变更检测

## [1.0.5-beta.15] - 2025-02-06

### 新增
- 可配置刷新间隔（最小 5 秒）
- 支持 SQL.js，提升跨平台兼容性
- 新的数据库错误处理与日志机制

### 变更
- 以 SQL.js 替换 SQLite3，消除原生依赖
- 全面重构数据库处理以提升可靠性
- 更新依赖与锁文件
- 通过移除 postinstall 简化安装流程

### 移除
- 移除 SQLite3 原生依赖及相关构建脚本
- 移除数据库连接池与监控逻辑
- 移除未使用的依赖与开发文件

### 修复
- 可能影响 ARM 架构的安装问题
- 数据库文件路径解析逻辑
- 数据库处理中的内存泄漏
- 令牌获取过程的错误处理

## [1.0.5-beta.3] - 2024-02-14

### 新增
- 支持 API 响应中的 `startOfMonth` 字段
- 智能通知系统，支持可配置阈值
- 可选的状态栏配色，支持阈值配置
- 支持 Cursor Nightly 版本的数据库路径
- 更紧凑现代的工具提示
- 改进设置可达性

### 变更
- 改进基于使用量计费的账单周期（第 3/4 天）处理
- 增强错误处理与 API 响应解析
- 改进启动阶段的通知与状态栏行为
- 优化设置导航与可达性
- 工具提示布局更规整

### 修复
- 启动阶段的通知与状态栏可见性问题
- 启动时重复通知的问题
- 在未打开文件时设置按钮不可用的问题
- 通知期间状态栏可见性

### 已知问题
- 暂不支持 macOS（仍在推进中）

## [1.0.4] - 2025-02-02

### 新增
- WSL（Windows Subsystem for Linux）数据库路径支持
- 基于使用百分比的动态状态栏颜色
- 工具提示中的交互按钮，便于快捷操作：
  - 刷新统计
  - 打开设置
  - 使用量计费设置
- 调试日志系统与相应配置
- 工具提示格式与对齐优化：
  - 将周期与“最后更新”合并为一行
  - 左侧显示周期，右侧显示“最后更新”
  - 将“总花费”移至“当前使用”行
  - 居中显示分组标题
  - 新增操作按钮区块
- 动态状态栏改进：
  - 基于使用量的配色方案
  - 视觉状态指示
  - 自定义配色支持

### 变更
- 增强数据库连接的错误处理
- 改进 WSL 检测与路径解析
- 使用信息的视觉组织更清晰
- 基于使用级别的状态栏颜色过渡更平滑
- 增加详细日志以便调试
- 改进命令处理与交互

## [1.0.2] - 2025-02-02

### 新增
- 点击状态栏直达设置
- 从本地数据库自动获取会话令牌

### 变更
- 工具提示 UI 优化（格式与图标）
- 分隔符样式优化，提升可读性
- 更新状态栏图标，风格更统一

## [1.0.1] - 2025-02-02

### 新增
- 扩展图标，便于在 VS Code 市场中识别
- 改进状态栏工具提示的格式
- 列表项对齐更合理

## [1.0.0] - 2025-02-02

### 新增
- 初始发布
- 在状态栏展示 Cursor 使用统计
- 会话令牌管理
- 实时统计更新


